<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StoryGrid Direct Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      color: #333;
      text-align: center;
    }
    
    .container {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 5px;
      background-color: #f9f9f9;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    textarea {
      height: 100px;
      resize: vertical;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    #upload-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
    }
    
    .success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .preview-item {
      width: 150px;
      position: relative;
    }
    
    .preview-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .preview-item p {
      margin: 5px 0;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .login-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    #token-input {
      width: 60%;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>StoryGrid Direct Upload</h1>
  
  <div class="login-container">
    <input type="text" id="token-input" placeholder="Paste your authentication token here">
    <button id="save-token">Save Token</button>
  </div>
  
  <div class="container">
    <h2>Create Story with Direct Upload</h2>
    
    <div class="form-group">
      <label for="story-title">Story Title:</label>
      <input type="text" id="story-title" placeholder="Enter your story title">
    </div>
    
    <div class="form-group">
      <label for="story-content">Story Content:</label>
      <textarea id="story-content" placeholder="Write your story content here"></textarea>
    </div>
    
    <div class="form-group">
      <label for="file-upload">Upload Images:</label>
      <input type="file" id="file-upload" accept="image/*" multiple>
      <p>Select one or more images from your device to upload</p>
    </div>
    
    <div id="preview-container" class="preview-container"></div>
    
    <button id="upload-button" disabled>Upload and Create Story</button>
    
    <div id="upload-status"></div>
  </div>
  
  <script>
    // DOM elements
    const tokenInput = document.getElementById('token-input');
    const saveTokenButton = document.getElementById('save-token');
    const titleInput = document.getElementById('story-title');
    const contentInput = document.getElementById('story-content');
    const fileInput = document.getElementById('file-upload');
    const uploadButton = document.getElementById('upload-button');
    const uploadStatus = document.getElementById('upload-status');
    const previewContainer = document.getElementById('preview-container');
    
    // Cloudinary configuration
    const CLOUDINARY_CLOUD_NAME = 'YOUR_CLOUD_NAME'; // Replace with your cloud name
    const UPLOAD_PRESET = 'my_unsigned_preset'; // Replace with your preset name
    
    // API configuration
    const API_URL = 'http://localhost:3000/api';
    
    // Variables to store state
    let token = localStorage.getItem('authToken') || '';
    let selectedFiles = [];
    let uploadedMedia = [];
    
    // Initialize UI
    if (token) {
      tokenInput.value = token;
      uploadButton.disabled = false;
    }
    
    // Event listeners
    saveTokenButton.addEventListener('click', saveToken);
    fileInput.addEventListener('change', handleFileSelect);
    uploadButton.addEventListener('click', handleUpload);
    
    // Function to save the authentication token
    function saveToken() {
      token = tokenInput.value.trim();
      if (token) {
        localStorage.setItem('authToken', token);
        uploadStatus.textContent = 'Token saved successfully';
        uploadStatus.className = 'success';
        uploadButton.disabled = selectedFiles.length === 0;
      } else {
        uploadStatus.textContent = 'Please enter a valid token';
        uploadStatus.className = 'error';
      }
    }
    
    // Function to handle file selection
    function handleFileSelect(e) {
      selectedFiles = Array.from(e.target.files);
      
      // Clear preview
      previewContainer.innerHTML = '';
      
      if (selectedFiles.length > 0) {
        // Enable upload button if we have a token
        uploadButton.disabled = !token;
        
        // Generate previews
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            
            const fileName = document.createElement('p');
            fileName.textContent = file.name;
            
            previewItem.appendChild(img);
            previewItem.appendChild(fileName);
            previewContainer.appendChild(previewItem);
          };
          
          reader.readAsDataURL(file);
        });
      } else {
        // Disable upload button if no files selected
        uploadButton.disabled = true;
      }
    }
    
    // Function to upload a single file to Cloudinary
    async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      
      const response = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`,
        {
          method: 'POST',
          body: formData
        }
      );
      
      if (!response.ok) {
        throw new Error(`Upload failed with status: ${response.status}`);
      }
      
      return await response.json();
    }
    
    // Function to save uploaded media to StoryGrid
    async function saveMediaToStoryGrid(cloudinaryData) {
      const response = await fetch(`${API_URL}/media/saveUploadedMedia`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          data: {
            url: cloudinaryData.secure_url,
            type: cloudinaryData.resource_type === 'image' ? 'image' : 'video',
            metadata: {
              publicId: cloudinaryData.public_id,
              format: cloudinaryData.format,
              size: cloudinaryData.bytes
            }
          }
        })
      });
      
      return await response.json();
    }
    
    // Function to create a story with uploaded media
    async function createStory(mediaItems) {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !content) {
        throw new Error('Title and content are required');
      }
      
      const response = await fetch(`${API_URL}/story/createStory`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          data: {
            title,
            content,
            tags: ['uploaded', 'from-device'],
            media: mediaItems.map(media => ({
              url: media.url,
              type: media.type
            }))
          }
        })
      });
      
      return await response.json();
    }
    
    // Function to handle the complete upload and story creation process
    async function handleUpload() {
      if (selectedFiles.length === 0) {
        uploadStatus.textContent = 'Please select at least one file';
        uploadStatus.className = 'error';
        return;
      }
      
      if (!titleInput.value.trim() || !contentInput.value.trim()) {
        uploadStatus.textContent = 'Please provide a title and content for your story';
        uploadStatus.className = 'error';
        return;
      }
      
      // Disable button and show status
      uploadButton.disabled = true;
      uploadStatus.textContent = 'Uploading files to Cloudinary...';
      uploadStatus.className = 'info';
      
      try {
        // Upload each file to Cloudinary
        const cloudinaryUploads = [];
        
        for (let i = 0; i < selectedFiles.length; i++) {
          uploadStatus.textContent = `Uploading file ${i + 1} of ${selectedFiles.length}...`;
          const cloudinaryResult = await uploadToCloudinary(selectedFiles[i]);
          cloudinaryUploads.push(cloudinaryResult);
        }
        
        // Save each uploaded media to StoryGrid
        uploadStatus.textContent = 'Saving media to StoryGrid...';
        const mediaItems = [];
        
        for (let i = 0; i < cloudinaryUploads.length; i++) {
          const cloudinaryData = cloudinaryUploads[i];
          const saveResult = await saveMediaToStoryGrid(cloudinaryData);
          
          if (saveResult.status === 201) {
            mediaItems.push({
              url: cloudinaryData.secure_url,
              type: cloudinaryData.resource_type === 'image' ? 'image' : 'video'
            });
          }
        }
        
        // Create story with the uploaded media
        uploadStatus.textContent = 'Creating story...';
        const storyResult = await createStory(mediaItems);
        
        if (storyResult.status === 201) {
          uploadStatus.innerHTML = `
            <strong>Story created successfully!</strong><br>
            Title: ${titleInput.value}<br>
            Media: ${mediaItems.length} items<br>
            Your story will now appear in your feed.
          `;
          uploadStatus.className = 'success';
          
          // Reset form
          titleInput.value = '';
          contentInput.value = '';
          fileInput.value = '';
          previewContainer.innerHTML = '';
          selectedFiles = [];
        } else {
          throw new Error(storyResult.msg || 'Failed to create story');
        }
      } catch (error) {
        console.error('Upload process failed:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.className = 'error';
      } finally {
        // Re-enable button
        uploadButton.disabled = selectedFiles.length === 0;
      }
    }
  </script>
</body>
</html> 